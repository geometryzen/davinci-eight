<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/davinci-eight/glsl/expr.ts - davinci-eight</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="davinci-eight"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.77.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ArrowBuilder.html">ArrowBuilder</a></li>
                                <li><a href="../classes/ArrowOptions.html">ArrowOptions</a></li>
                                <li><a href="../classes/AttribDataInfos.html">AttribDataInfos</a></li>
                                <li><a href="../classes/AttribLocation.html">AttribLocation</a></li>
                                <li><a href="../classes/AttribLocation..html">AttribLocation.</a></li>
                                <li><a href="../classes/AttribMetaInfo
                TODO: AttribPointerInfo?.html">AttribMetaInfo
                TODO: AttribPointerInfo?</a></li>
                                <li><a href="../classes/AttribMetaInfos.html">AttribMetaInfos</a></li>
                                <li><a href="../classes/AttribProvider.html">AttribProvider</a></li>
                                <li><a href="../classes/BarnGeometry.html">BarnGeometry</a></li>
                                <li><a href="../classes/BoxBuilder.html">BoxBuilder</a></li>
                                <li><a href="../classes/BoxMesh.html">BoxMesh</a></li>
                                <li><a href="../classes/Cartesian1.html">Cartesian1</a></li>
                                <li><a href="../classes/Cartesian2.html">Cartesian2</a></li>
                                <li><a href="../classes/Cartesian3.html">Cartesian3</a></li>
                                <li><a href="../classes/Cartesian4.html">Cartesian4</a></li>
                                <li><a href="../classes/Color.html">Color</a></li>
                                <li><a href="../classes/Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed..html">Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed.</a></li>
                                <li><a href="../classes/CuboidMesh.html">CuboidMesh</a></li>
                                <li><a href="../classes/CylinderArgs.html">CylinderArgs</a></li>
                                <li><a href="../classes/Drawable.html">Drawable</a></li>
                                <li><a href="../classes/DrawMode.html">DrawMode</a></li>
                                <li><a href="../classes/ElementArray.html">ElementArray</a></li>
                                <li><a href="../classes/ElementBuffer.html">ElementBuffer</a></li>
                                <li><a href="../classes/EllipsoidMesh.html">EllipsoidMesh</a></li>
                                <li><a href="../classes/Face3.html">Face3</a></li>
                                <li><a href="../classes/frustum.html">frustum</a></li>
                                <li><a href="../classes/Frustum.html">Frustum</a></li>
                                <li><a href="../classes/Geometry.html">Geometry</a></li>
                                <li><a href="../classes/GeometryAdapter.html">GeometryAdapter</a></li>
                                <li><a href="../classes/KleinBottleGeometry.html">KleinBottleGeometry</a></li>
                                <li><a href="../classes/Line3.html">Line3</a></li>
                                <li><a href="../classes/Matrix4.html">Matrix4</a></li>
                                <li><a href="../classes/Mutable.html">Mutable</a></li>
                                <li><a href="../classes/perspective.html">perspective</a></li>
                                <li><a href="../classes/Perspective.html">Perspective</a></li>
                                <li><a href="../classes/Point3.html">Point3</a></li>
                                <li><a href="../classes/Renderer.html">Renderer</a></li>
                                <li><a href="../classes/RenderingContextUser.html">RenderingContextUser</a></li>
                                <li><a href="../classes/ShaderProgram.html">ShaderProgram</a></li>
                                <li><a href="../classes/ShaderVariableDecl.html">ShaderVariableDecl</a></li>
                                <li><a href="../classes/Spinor3.html">Spinor3</a></li>
                                <li><a href="../classes/Symbolic.html">Symbolic</a></li>
                                <li><a href="../classes/UniformLocation.html">UniformLocation</a></li>
                                <li><a href="../classes/UniformMetaInfo.html">UniformMetaInfo</a></li>
                                <li><a href="../classes/UniformMetaInfos.html">UniformMetaInfos</a></li>
                                <li><a href="../classes/UniformProvider.html">UniformProvider</a></li>
                                <li><a href="../classes/Vector1.html">Vector1</a></li>
                                <li><a href="../classes/Vector2.html">Vector2</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/Vector4.html">Vector4</a></li>
                                <li><a href="../classes/view.html">view</a></li>
                                <li><a href="../classes/View.html">View</a></li>
                                <li><a href="../classes/WindowAnimationRunner.html">WindowAnimationRunner</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/EIGHT.html">EIGHT</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/davinci-eight/glsl/expr.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
//
// See javascript.crockford.com/tdop/tdop.html
//
// We assume that the source text has been transformed into an array of tokens.
//
/// &lt;reference path=&#x27;./Symbol.d.ts&#x27;/&gt;
/// &lt;reference path=&#x27;./Token.d.ts&#x27;/&gt;

var state;
/**
 * The current token.
 */
var token: Token;
var tokens: Token[];
var idx: number;

function fail(message) {
  return function() { return state.unexpected(message) }
}

/**
 * The prototype for all other symbols. Its method will usually be overridden.
 */
let original_symbol = {
  nud: function() {
    return this.children &amp;&amp; this.children.length ? this : fail(&#x27;unexpected&#x27;)()
  },
  led: fail(&#x27;missing operator&#x27;)
}

let symbol_table: {[id:string]:Symbol} = {};

let itself: NullDenotation = function() {
  return this
}

/**
 * A function that makes symbols and looks them up in a cache.
 * @param id Identifier
 * @param bp Binding Power. Optional. Defaults to zero.
 */
function symbol(id: string, bp?: number) {
  var sym: Symbol = symbol_table[id];
  bp = bp || 0
  if(sym) {
    if(bp &gt; sym.lbp) {
      sym.lbp = bp
    }
  }
  else {
    sym = Object.create(original_symbol)
    sym.id = id 
    sym.lbp = bp
    symbol_table[id] = sym
  }
  return sym
}

function infix(id: string, bp: number, led?: LeftDenotation): void {
  var sym: Symbol = symbol(id, bp)
  sym.led = led || function(left) {
    this.children = [left, expression(bp)]
    this.type = &#x27;binary&#x27;
    return this
  }
}

function infixr(id: string, bp: number, led?: LeftDenotation): Symbol {
  var sym = symbol(id, bp)
  sym.led = led || function(left) {
    this.children = [left, expression(bp - 1)]
    this.type = &#x27;binary&#x27;
    return this
  }
  return sym
}

function prefix(id: string, nud?: NullDenotation): Symbol {
  var sym = symbol(id)
  sym.nud = nud || function() {
    this.children = [expression(70)]
    this.type = &#x27;unary&#x27;
    return this
  }
  return sym
}

function suffix(id: string): void {
  var sym = symbol(id, 150)
  sym.led = function(left) {
    this.children = [left]
    this.type = &#x27;suffix&#x27;
    return this
  }
}

function assignment(id: string): Symbol {
  return infixr(id, 10, function(left) {
    this.children = [left, expression(9)]
    this.assignment = true
    this.type = &#x27;assign&#x27;
    return this
  })
}

// parentheses included to avoid collisions with user-defined tokens.
symbol(&#x27;(ident)&#x27;).nud = itself
symbol(&#x27;(keyword)&#x27;).nud = itself
symbol(&#x27;(builtin)&#x27;).nud = itself
symbol(&#x27;(literal)&#x27;).nud = itself
symbol(&#x27;(end)&#x27;);  // Indicates the end of the token stream.

symbol(&#x27;:&#x27;)
symbol(&#x27;;&#x27;)
symbol(&#x27;,&#x27;)
symbol(&#x27;)&#x27;)
symbol(&#x27;]&#x27;)
symbol(&#x27;}&#x27;)

infixr(&#x27;&amp;&amp;&#x27;, 30)
infixr(&#x27;||&#x27;, 30)
infix(&#x27;|&#x27;, 43)
infix(&#x27;^&#x27;, 44)
infix(&#x27;&amp;&#x27;, 45)
infix(&#x27;==&#x27;, 46)
infix(&#x27;!=&#x27;, 46)
infix(&#x27;&lt;&#x27;, 47)
infix(&#x27;&lt;=&#x27;, 47)
infix(&#x27;&gt;&#x27;, 47)
infix(&#x27;&gt;=&#x27;, 47)
infix(&#x27;&gt;&gt;&#x27;, 48)
infix(&#x27;&lt;&lt;&#x27;, 48)
infix(&#x27;+&#x27;, 50)
infix(&#x27;-&#x27;, 50)
infix(&#x27;*&#x27;, 60)
infix(&#x27;/&#x27;, 60)
infix(&#x27;%&#x27;, 60)
infix(&#x27;?&#x27;, 20, function(left: Symbol) {
  this.children = [left, expression(0), (advance(&#x27;:&#x27;), expression(0))]; // original.
  //this.children = [];
  //this.children.push(left);
  //this.children.push(expression(0));
  //advance(&#x27;:&#x27;);
  //this.children.push(expression(0));
  this.type = &#x27;ternary&#x27;
  return this
})
infix(&#x27;.&#x27;, 80, function(left) {
  token.type = &#x27;literal&#x27;
  state.fake(token)
  this.children = [left, token]
  advance()
  return this
})
infix(&#x27;[&#x27;, 80, function(left) {
  this.children = [left, expression(0)]
  this.type = &#x27;binary&#x27;
  advance(&#x27;]&#x27;)
  return this
})
infix(&#x27;(&#x27;, 80, function(left) {
  this.children = [left]
  this.type = &#x27;call&#x27;

  if(token.data !== &#x27;)&#x27;) {
    while(1) {
      this.children.push(expression(0));
      if(token.data !== &#x27;,&#x27;) {
        break;
      }
      advance(&#x27;,&#x27;);
    }
  }
  advance(&#x27;)&#x27;)
  return this
})

prefix(&#x27;-&#x27;)
prefix(&#x27;+&#x27;)
prefix(&#x27;!&#x27;)
prefix(&#x27;~&#x27;)
prefix(&#x27;defined&#x27;)
prefix(&#x27;(&#x27;, function() {
  this.type = &#x27;group&#x27;
  this.children = [expression(0)]
  advance(&#x27;)&#x27;)
  return this 
})
prefix(&#x27;++&#x27;)
prefix(&#x27;--&#x27;)
suffix(&#x27;++&#x27;)
suffix(&#x27;--&#x27;)

assignment(&#x27;=&#x27;)
assignment(&#x27;+=&#x27;)
assignment(&#x27;-=&#x27;)
assignment(&#x27;*=&#x27;)
assignment(&#x27;/=&#x27;)
assignment(&#x27;%=&#x27;)
assignment(&#x27;&amp;=&#x27;)
assignment(&#x27;|=&#x27;)
assignment(&#x27;^=&#x27;)
assignment(&#x27;&gt;&gt;=&#x27;)
assignment(&#x27;&lt;&lt;=&#x27;)

function expr(incoming_state, incoming_tokens?: Token[]): void {

  function emit(node) {
    state.unshift(node, false)
    for(var i = 0, len = node.children.length; i &lt; len; ++i) {
      emit(node.children[i])
    }
    state.shift()
  }

  state = incoming_state
  tokens = incoming_tokens
  idx = 0
  var result

  if(!tokens.length) {
    return
  }

  advance()
  result = expression(0)
  result.parent = state[0]
  emit(result)

  if(idx &lt; tokens.length) {
    throw new Error(&#x27;did not use all tokens&#x27;)
  }

  result.parent.children = [result]
}

/**
 * The heart of top-down precedence parsing (Pratt).
 * @param rbp Right Binding Power.
 */
function expression(rbp: number): Symbol {
  var left: Symbol;
  var t: Token = token;

  advance();

  left = t.nud();
  while(rbp &lt; token.lbp) {
    t = token
    advance()
    left = t.led(left)
  }
  return left
}

/**
 * Make a new token from the next simple object in the array and assign to the token variable
 */
function advance(id?): Token {
  var next: Token;
  var value: string;
  var type: string;
  /**
   * Symbol obtained from the symbol lookup table.
   */
  var output: Symbol;

  if(id &amp;&amp; token.data !== id) {
    return state.unexpected(&#x27;expected &#x60;&#x27;+ id + &#x27;&#x60;, got &#x60;&#x27;+token.data+&#x27;&#x60;&#x27;)
  }

  if(idx &gt;= tokens.length) {
    token = symbol_table[&#x27;(end)&#x27;]
    return
  }

  next = tokens[idx++]
  value = next.data
  type = next.type

  if(type === &#x27;ident&#x27;) {
    output = state.scope.find(value) || state.create_node()
    type = output.type
  }
  else if(type === &#x27;builtin&#x27;) {
    output = symbol_table[&#x27;(builtin)&#x27;]
  }
  else if(type === &#x27;keyword&#x27;) {
    output = symbol_table[&#x27;(keyword)&#x27;]
  }
  else if(type === &#x27;operator&#x27;) {
    output = symbol_table[value]
    if(!output) {
      return state.unexpected(&#x27;unknown operator &#x60;&#x27;+value+&#x27;&#x60;&#x27;)
    }
  }
  else if(type === &#x27;float&#x27; || type === &#x27;integer&#x27;) {
    type = &#x27;literal&#x27;
    output = symbol_table[&#x27;(literal)&#x27;]
  }
  else {
    return state.unexpected(&#x27;unexpected token.&#x27;)
  }

  if(output) {
    if(!output.nud) { output.nud = itself }
    if(!output.children) { output.children = [] }
  }

  // FIXME: This should be assigning to token?
  output = Object.create(output)
  output.token = next
  output.type = type
  if(!output.data) {
    output.data = value
  }

  // I don&#x27;t think the assignment is required.
  // It also may be effing up the type safety.
  return token = output
}

export = expr;
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
