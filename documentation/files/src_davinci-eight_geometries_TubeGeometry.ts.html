<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/davinci-eight/geometries/TubeGeometry.ts - davinci-eight</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="davinci-eight"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 2.85.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/ArrowBuilder.html">ArrowBuilder</a></li>
                                <li><a href="../classes/ArrowOptions.html">ArrowOptions</a></li>
                                <li><a href="../classes/AttribDataInfos.html">AttribDataInfos</a></li>
                                <li><a href="../classes/AttribLocation.html">AttribLocation</a></li>
                                <li><a href="../classes/AttribLocation..html">AttribLocation.</a></li>
                                <li><a href="../classes/AttribMetaInfo
                TODO: AttribPointerInfo?.html">AttribMetaInfo
                TODO: AttribPointerInfo?</a></li>
                                <li><a href="../classes/AttribMetaInfos.html">AttribMetaInfos</a></li>
                                <li><a href="../classes/AttribProvider.html">AttribProvider</a></li>
                                <li><a href="../classes/BarnGeometry.html">BarnGeometry</a></li>
                                <li><a href="../classes/BoxBuilder.html">BoxBuilder</a></li>
                                <li><a href="../classes/BoxMesh.html">BoxMesh</a></li>
                                <li><a href="../classes/Cartesian1.html">Cartesian1</a></li>
                                <li><a href="../classes/Cartesian2.html">Cartesian2</a></li>
                                <li><a href="../classes/Cartesian3.html">Cartesian3</a></li>
                                <li><a href="../classes/Cartesian4.html">Cartesian4</a></li>
                                <li><a href="../classes/Color.html">Color</a></li>
                                <li><a href="../classes/Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed..html">Color
                WARNING: In many object-oriented designs, types representing values are completely immutable.
                In a graphics library where data changes rapidly and garbage collection might become an issue,
                it is common to use reference types, such as in this design. This mutability can lead to
                difficult bugs because it is hard to reason about where a color may have changed.</a></li>
                                <li><a href="../classes/CuboidMesh.html">CuboidMesh</a></li>
                                <li><a href="../classes/CylinderArgs.html">CylinderArgs</a></li>
                                <li><a href="../classes/Drawable.html">Drawable</a></li>
                                <li><a href="../classes/DrawMode.html">DrawMode</a></li>
                                <li><a href="../classes/ElementArray.html">ElementArray</a></li>
                                <li><a href="../classes/ElementBuffer.html">ElementBuffer</a></li>
                                <li><a href="../classes/EllipsoidMesh.html">EllipsoidMesh</a></li>
                                <li><a href="../classes/Face3.html">Face3</a></li>
                                <li><a href="../classes/frustum.html">frustum</a></li>
                                <li><a href="../classes/Frustum.html">Frustum</a></li>
                                <li><a href="../classes/Geometry3.html">Geometry3</a></li>
                                <li><a href="../classes/GeometryAdapter.html">GeometryAdapter</a></li>
                                <li><a href="../classes/KleinBottleGeometry.html">KleinBottleGeometry</a></li>
                                <li><a href="../classes/Line3.html">Line3</a></li>
                                <li><a href="../classes/Matrix4.html">Matrix4</a></li>
                                <li><a href="../classes/Mutable.html">Mutable</a></li>
                                <li><a href="../classes/perspective.html">perspective</a></li>
                                <li><a href="../classes/Perspective.html">Perspective</a></li>
                                <li><a href="../classes/Point3.html">Point3</a></li>
                                <li><a href="../classes/Renderer.html">Renderer</a></li>
                                <li><a href="../classes/RenderingContextUser.html">RenderingContextUser</a></li>
                                <li><a href="../classes/ShaderProgram.html">ShaderProgram</a></li>
                                <li><a href="../classes/ShaderVariableDecl.html">ShaderVariableDecl</a></li>
                                <li><a href="../classes/Simplex.html">Simplex</a></li>
                                <li><a href="../classes/Spinor3.html">Spinor3</a></li>
                                <li><a href="../classes/Symbolic.html">Symbolic</a></li>
                                <li><a href="../classes/UniformLocation.html">UniformLocation</a></li>
                                <li><a href="../classes/UniformMetaInfo.html">UniformMetaInfo</a></li>
                                <li><a href="../classes/UniformMetaInfos.html">UniformMetaInfos</a></li>
                                <li><a href="../classes/UniformProvider.html">UniformProvider</a></li>
                                <li><a href="../classes/Vector1.html">Vector1</a></li>
                                <li><a href="../classes/Vector2.html">Vector2</a></li>
                                <li><a href="../classes/Vector3.html">Vector3</a></li>
                                <li><a href="../classes/Vector4.html">Vector4</a></li>
                                <li><a href="../classes/view.html">view</a></li>
                                <li><a href="../classes/View.html">View</a></li>
                                <li><a href="../classes/WindowAnimationRunner.html">WindowAnimationRunner</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/EIGHT.html">EIGHT</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/davinci-eight/geometries/TubeGeometry.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @author WestLangley / https://github.com/WestLangley
 * @author zz85 / https://github.com/zz85
 * @author miningold / https://github.com/miningold
 * @author jonobr1 / https://github.com/jonobr1
 *
 * Modified from the TorusKnotGeometry by @oosmoxiecode
 *
 * Creates a tube which extrudes along a 3d spline
 *
 * Uses parallel transport frames as described in
 * http://www.cs.indiana.edu/pub/techreports/TR425.pdf
 */
import clamp = require(&#x27;../math/clamp&#x27;);
import Curve = require(&#x27;../curves/Curve&#x27;);
import Face3 = require(&#x27;../core/Face3&#x27;);
import Geometry3 = require(&#x27;../geometries/Geometry3&#x27;);
import Matrix4 = require(&#x27;../math/Matrix4&#x27;);
import Vector2 = require(&#x27;../math/Vector2&#x27;);
import Vector3 = require(&#x27;../math/Vector3&#x27;);

class TubeGeometry extends Geometry3 {
  public static NoTaper = function (u: number): number {return 1;};
  public static SinusoidalTaper = function (u: number): number {return Math.sin(Math.PI * u);};
  public tangents: Vector3[];
  public normals: Vector3[];
  public binormals: Vector3[];
  constructor(path: Curve, segments?: number, radius?: number, radialSegments?: number, closed?: boolean, taper?: (u: number)=&gt;number) {
    super();
    segments = segments || 64;
    radius = radius || 0.05;
    radialSegments = radialSegments || 16;
    closed = closed || false;
    taper = taper || TubeGeometry.NoTaper;

    var grid: number[][] = [];

    var scope = this;
    var tangent: Vector3;
    var normal: Vector3;
    var binormal: Vector3;
    var numpoints = segments + 1;

    var u: number;
    var v: number;
    var r: number;

    var cx: number;
    var cy: number;
    var pos: Vector3;
    var pos2: Vector3 = new Vector3([0, 0, 0]);
    var i: number;
    var j: number;
    var ip: number;
    var jp: number;
    var a: number;
    var b: number;
    var c: number;
    var d: number;
    var uva: Vector2;
    var uvb: Vector2;
    var uvc: Vector2;
    var uvd: Vector2;

    var frames = new FrenetFrames(path, segments, closed);
    var tangents = frames.tangents;
    var normals = frames.normals;
    var binormals = frames.binormals;

    // proxy internals
    this.tangents = tangents;
    this.normals = normals;
    this.binormals = binormals;

    function vert(x: number, y: number, z: number) {
      return scope.vertices.push(new Vector3([x, y, z])) - 1;
    }

    // consruct the grid

    for ( i = 0; i &lt; numpoints; i ++ ) {

      grid[ i ] = [];

      u = i / ( numpoints - 1 );

      pos = path.getPointAt( u );

      tangent = tangents[ i ];
      normal = normals[ i ];
      binormal = binormals[ i ];

      r = radius * taper( u );

      for ( j = 0; j &lt; radialSegments; j ++ ) {

        v = j / radialSegments * 2 * Math.PI;

        cx = - r * Math.cos( v ); // TODO: Hack: Negating it so it faces outside.
        cy = r * Math.sin( v );

        pos2.copy( pos );
        pos2.x += cx * normal.x + cy * binormal.x;
        pos2.y += cx * normal.y + cy * binormal.y;
        pos2.z += cx * normal.z + cy * binormal.z;

        grid[ i ][ j ] = vert( pos2.x, pos2.y, pos2.z );

      }
    }

    for ( i = 0; i &lt; segments; i ++ ) {

      for ( j = 0; j &lt; radialSegments; j ++ ) {

        ip = ( closed ) ? (i + 1) % segments : i + 1;
        jp = (j + 1) % radialSegments;

        a = grid[ i ][ j ];    // *** NOT NECESSARILY PLANAR ! ***
        b = grid[ ip ][ j ];
        c = grid[ ip ][ jp ];
        d = grid[ i ][ jp ];

        uva = new Vector2([i / segments, j / radialSegments]);
        uvb = new Vector2([( i + 1 ) / segments, j / radialSegments]);
        uvc = new Vector2([( i + 1 ) / segments, ( j + 1 ) / radialSegments]);
        uvd = new Vector2([i / segments, ( j + 1 ) / radialSegments]);

        this.faces.push( new Face3( a, b, d ) );
        this.faceVertexUvs[ 0 ].push( [ uva, uvb, uvd ] );

        this.faces.push( new Face3( b, c, d ) );
        this.faceVertexUvs[ 0 ].push( [ uvb.clone(), uvc, uvd.clone() ] );

      }
    }

    this.computeFaceNormals();
    this.computeVertexNormals();
  }
}

export = TubeGeometry;

// For computing of Frenet frames, exposing the tangents, normals and binormals the spline
class FrenetFrames {
  public tangents: Vector3[];
  public normals: Vector3[];
  public binormals: Vector3[];
  constructor(path: Curve, segments: number, closed: boolean) {
    var normal = new Vector3([0, 0, 0]);
    var tangents: Vector3[] = [];
    var normals: Vector3[] = [];
    var binormals: Vector3[] = [];

    var vec = new Vector3([0, 0, 0]);
    var mat = Matrix4.identity();

    var numpoints: number = segments + 1;
    var theta: number;
    let epsilon = 0.0001;
    let epsilonSquared = 0.0001 * 0.0001;
    var smallest: number;

    // TODO: The folloowing should be a Vector3
    var tx: number;
    var ty: number;
    var tz: number;
    var i: number;
    var u: number;


    // expose internals
    this.tangents = tangents;
    this.normals = normals;
    this.binormals = binormals;

    // compute the tangent vectors for each segment on the path

    for (i = 0; i &lt; numpoints; i++) {

        u = i / (numpoints - 1);

        tangents[i] = path.getTangentAt(u);
        tangents[i].normalize();

    }

    initialNormal3();

    /*
    function initialNormal1(lastBinormal) {
      // fixed start binormal. Has dangers of 0 vectors
      normals[ 0 ] = new THREE.Vector3();
      binormals[ 0 ] = new THREE.Vector3();
      if (lastBinormal===undefined) lastBinormal = new THREE.Vector3( 0, 0, 1 );
      normals[ 0 ].crossVectors( lastBinormal, tangents[ 0 ] ).normalize();
      binormals[ 0 ].crossVectors( tangents[ 0 ], normals[ 0 ] ).normalize();
    }
    function initialNormal2() {
      // This uses the Frenet-Serret formula for deriving binormal
      var t2 = path.getTangentAt( epsilon );
      normals[ 0 ] = new THREE.Vector3().subVectors( t2, tangents[ 0 ] ).normalize();
      binormals[ 0 ] = new THREE.Vector3().crossVectors( tangents[ 0 ], normals[ 0 ] );
      normals[ 0 ].crossVectors( binormals[ 0 ], tangents[ 0 ] ).normalize(); // last binormal x tangent
      binormals[ 0 ].crossVectors( tangents[ 0 ], normals[ 0 ] ).normalize();
    }
    */

    function initialNormal3() {
        // select an initial normal vector perpendicular to the first tangent vector,
        // and in the direction of the smallest tangent xyz component

        normals[0] = new Vector3([0, 0, 0]);
        binormals[0] = new Vector3([0, 0, 0]);
        smallest = Number.MAX_VALUE;
        tx = Math.abs(tangents[0].x);
        ty = Math.abs(tangents[0].y);
        tz = Math.abs(tangents[0].z);

        if (tx &lt;= smallest) {
            smallest = tx;
            normal.set(1, 0, 0);
        }

        if (ty &lt;= smallest) {
            smallest = ty;
            normal.set(0, 1, 0);
        }

        if (tz &lt;= smallest) {
            normal.set(0, 0, 1);
        }

        vec.crossVectors(tangents[0], normal).normalize();

        normals[0].crossVectors(tangents[0], vec);
        binormals[0].crossVectors(tangents[0], normals[0]);
    }


    // compute the slowly-varying normal and binormal vectors for each segment on the path

    for (i = 1; i &lt; numpoints; i++) {

        normals[i] = normals[i - 1].clone();

        binormals[i] = binormals[i - 1].clone();

        vec.crossVectors(tangents[i - 1], tangents[i]);

        if (vec.magnitude() &gt; epsilon) {

            vec.normalize();

            theta = Math.acos(clamp(tangents[i - 1].dot(tangents[i]), - 1, 1)); // clamp for floating pt errors

            // TODO: don&#x27;t like this applyMatrix4 use applySpinor
            normals[i].applyMatrix4(mat.rotationAxis(vec, theta));

        }

        binormals[i].crossVectors(tangents[i], normals[i]);

    }


    // if the curve is closed, postprocess the vectors so the first and last normal vectors are the same

    if (closed) {

        theta = Math.acos(clamp(normals[0].dot(normals[numpoints - 1]), - 1, 1));
        theta /= (numpoints - 1);

        if (tangents[0].dot(vec.crossVectors(normals[0], normals[numpoints - 1])) &gt; 0) {

            theta = - theta;

        }

        for (i = 1; i &lt; numpoints; i++) {

            // twist a little...
            // TODO: Don&#x27;t like this applyMatrix4 use applySpinor
            normals[i].applyMatrix4(mat.rotationAxis(tangents[i], theta * i));
            binormals[i].crossVectors(tangents[i], normals[i]);

        }

    }
  }
}
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
